version: '3.9'

services:
  mysql:
    image: mysql:8.0
    container_name: drone_mysql
    environment:
      MYSQL_ROOT_PASSWORD: 1234
      MYSQL_DATABASE: drone_fastfood
    ports:
      - '3307:3306' # đổi cổng host sang 3307 để tránh xung đột nếu máy đang chạy MySQL
    command: ["--default-authentication-plugin=mysql_native_password","--lower_case_table_names=1"]
    volumes:
      - db_data:/var/lib/mysql
    healthcheck:
      test: ['CMD-SHELL', 'mysqladmin ping -h localhost -uroot -p1234']
      interval: 5s
      timeout: 3s
      retries: 20

  app:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: drone_app
    environment:
      # Máy chủ
      PORT: 3000
      NODE_ENV: production
      # Prisma/MySQL
      DATABASE_URL: mysql://root:1234@mysql:3306/drone_fastfood
      # Tự động seed dữ liệu mẫu khi khởi động (chỉ dùng cho demo/dev)
      AUTO_SEED: "true"
      # Xác thực và thanh toán (hãy thay đổi trong môi trường production)
      JWT_SECRET: changeme-in-dev
      PAYMENT_WEBHOOK_SECRET: dev-webhook-secret
      # Tùy chọn: Dùng OSRM công khai mặc định (hoặc tự cung cấp trong .env)
      # OSRM_BASE_URL: https://router.project-osrm.org
    ports:
      - '3000:3000'
    depends_on:
      mysql:
        condition: service_healthy
    restart: unless-stopped

volumes:
  db_data:
